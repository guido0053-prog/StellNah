<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StellNah</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b3d2e">
  <link rel="icon" href="./favicon.png">

  <style>
    body { font-family: system-ui, sans-serif; max-width: 1100px; margin: 0 auto; padding: 16px; background: #f2f2f2; }
    input { padding: 10px; font-size: 16px; background: #ffffff; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; background: #ffffff; }
    th { background: #f7f7f7; font-weight: 600; }
    th, td { border-bottom: 1px solid #e5e5e5; text-align: left; padding: 10px; vertical-align: top; font-size: 14px; }
    tr:hover { background: #fafafa; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .box { display: flex; flex-direction: column; gap: 6px; }
    .muted { font-size: 12px; opacity: .7; margin-top: 16px; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    .card { background: #ffffff; border-radius: 14px; padding: 18px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <div class="card">
    <h2>StellNah</h2>
    <p class="muted">Zentrumsnahe Stell- & Campingplätze mit Einkauf fußläufig (ca. 0,5 km). Ausgabe als Tabelle inkl. Google-Maps-Link.</p>

    <div class="row">
      <div class="box">
        <label>ZIELORT</label>
        <input id="zielort" type="text" placeholder="Zielort eingeben..." />
      </div>
      <div class="box">
        <label>SUCHRADIUS (km)</label>
        <input id="radius" type="number" value="20" min="1" max="300" />
      </div>
      <button id="start">Start</button>
    </div>

    <p id="status"></p>

    <div id="meta"></div>

    <div style="overflow-x:auto;">
      <table id="table" style="display:none;">
        <thead>
          <tr>
            <th>Typ</th>
            <th>Name</th>
            <th>Min Einkauf (m, Luftlinie)</th>
            <th>Zentrum (m, Luftlinie)</th>
            <th>Bäcker</th>
            <th>Metzger</th>
            <th>Supermarkt</th>
            <th>Google Maps</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="muted">
      Tipp: Wenn wenig Treffer kommen, probiere einen etwas größeren Suchradius oder einen Zielort wie „Stadtname, Deutschland“.
    </p>

    <script>
      // WICHTIG:
      // Hier kommt die Internet-Adresse (URL) deines Backends rein (z.B. von Render).
      const API_URL = "https://stellnah-backend.onrender.com/analyze";

      // Service Worker registrieren (für Installierbarkeit/Offline-Basics)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").catch(() => {});
        });
      }

      const el = (id) => document.getElementById(id);

      el("start").addEventListener("click", async () => {
        el("status").textContent = "Suche läuft…";
        el("meta").textContent = "";
        el("table").style.display = "none";
        el("tbody").innerHTML = "";

        const zielort = el("zielort").value.trim();
        const suchradius_km = Number(el("radius").value);

        // ✅ Schutzabfrage: Zielort darf nicht leer sein
        if (!zielort) {
          el("status").textContent = "Bitte einen Zielort eingeben.";
          alert("Bitte einen Zielort eingeben");
          return;
        }

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ zielort, suchradius_km })
          });
          if (!res.ok) throw new Error("API Fehler: " + res.status);

          const data = await res.json();
          const rows = data.results || [];

          const p = data.params || {};
          el("meta").innerHTML = `
            <span class="pill"><b>Zentrum:</b> ${data.zentrum?.name || "-"}</span>
            <span class="pill"><b>Einkauf:</b> ${p.einkauf_luftlinie_m ?? "?"} m</span>
            <span class="pill"><b>Zentrumsnah:</b> ${p.zentrum_luftlinie_m ?? "?"} m</span>
            <span class="pill"><b>Treffer:</b> ${rows.length}</span>
          `;

          el("status").textContent = rows.length ? "" : "Keine Treffer (Radius erhöhen oder anderen Zielort).";

          el("table").style.display = "table";
          for (const r of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.typ}</td>
              <td>${r.name}</td>
              <td style="text-align:right">${r.min_einkauf_m ?? ""}</td>
              <td style="text-align:right">${r.zentrum_m ?? ""}</td>
              <td>${r.baecker ? "✅" : ""}</td>
              <td>${r.metzger ? "✅" : ""}</td>
              <td>${r.supermarkt ? "✅" : ""}</td>
              <td><a href="${r.maps_link}" target="_blank" rel="noreferrer">öffnen</a></td>
            `;
            el("tbody").appendChild(tr);
          }

        } catch (e) {
          el("status").textContent = "Fehler: " + e;
        }
      });
    </script>
  </div>
</body>
</html>
